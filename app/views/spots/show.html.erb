<% content_for :title, @spot.name %>

<!-- スポット名 + ブックマークボタン -->
<div class="flex items-center justify-start px-3 py-3">
  <h1 class="font-bold text-4xl"><%= @spot.name %></h1>
  <div class="ml-2">
    <%= render 'spots/bookmark_buttons', { spot: @spot } %>
  </div>
</div>

<div class="grid sm:grid-cols-3">

  <!-- スポット画像 -->
  <% cache(@spot.cache_key_with_version + "/image") do %>
    <figure class="sm:col-span-2 mb-3">
      <%= image_tag @spot.image, class: "rounded" %>
    </figure>
  <% end %>

  <!-- 基本情報テーブル -->
  <div class="sm:col-span-1 mx-5 max-w-full break-words">
    <table class="table w-full border border-gray-800">
      <thead>
        <%# タイトル部 %>
        <tr class="border border-gray-800">
          <th class="text-xl text-center" colspan="2"><%= t('.basic_info') %></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <%# 説明部%>
          <td class="font-bold border border-gray-800"><%= t('activerecord.attributes.spot.body') %></td>
          <td class="border border-gray-800">
            <% if @spot.body.present? %>
              <div class="break-words max-h-32 overflow-y-auto">
                <%= simple_format(@spot.body) %>
              </div>
            <% else %>
              <%= t('.no_info') %>
            <% end %>
          </td>
        </tr>
        <tr>
          <%# URL部 %>
          <td class="font-bold border border-gray-800"><%= t('activerecord.attributes.spot.url') %></td>
          <td class="border border-gray-800 break-words max-h-16 overflow-y-auto max-w-32">
            <% if @spot.url.present? %>
              <%= link_to @spot.url.to_s, @spot.url.to_s, target: "_blank", class: "text-info break-words max-h-16 overflow-y-auto" %>
            <% else %>
              <%= t('.no_info') %>
            <% end %>
          </td>
        </tr>
        <tr>
          <%# 説明部%>
          <td class="font-bold border border-gray-800"><%= t('activerecord.attributes.spot.atmosphere') %></td>
          <td class="border border-gray-800">
            <% if @spot.atmosphere.present? %>
              <%= @spot.atmosphere %>
            <% else %>
              <%= t('.no_info') %>
            <% end %>
          </td>
        </tr>
        <tr>
        <tr>
          <!-- タグ部 -->
          <td class="font-bold border border-gray-800"><%= t('activerecord.attributes.spot.tag') %></td>
          <td>
            <% if @spot.tags.present? %>
              <div class="flex flex-wrap gap-2">
                <% @spot.tags.each do |tag| %>
                  <%= link_to tag.name, spots_path(q: { tags_name_eq: tag.name }), class: "badge badge-outline" %>
                <% end %>
              </div>
            <% else %>
              <%= t('.no_info') %>
            <% end %>
          </td>
        </tr>
        <tr>
          <%# 投稿者部 %>
          <td class="font-bold border border-gray-800"><%= t('activerecord.attributes.spot.user.name') %></td>
          <td class="border border-gray-800 break-words overflow-x-auto"><%= @spot.user.name %></td>
        </tr>
        <tr>
          <td class="border border-gray-800" colspan="2">
            <%= link_to "https://x.com/intent/tweet?text=#{CGI.escape("【#{@spot.name}】をシェアしました！\n\nスポット名：#{@spot.name}\n位置情報：#{@spot.prefecture.name + @spot.address}\n投稿者：#{@spot.user.name}\n\n#{request.url}\n#NighTrip #夜景")}", target: '_blank', class: "btn btn-neutral flex items-center gap-2" do %>
              <svg class="h-6 w-6 text-slate-200" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M4 4l11.733 16h4.267l-11.733 -16z" />
                <path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772" />
              </svg>
              <span><%= t('.share') %></span>
            <% end %>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<%# Google Maps部 %>
<div class="my-5 text-wrap">
  <% if @spot.latitude.present? && @spot.longitude.present? %>
    <h3 class="text-xl font-bold mb-1"><%= t('activerecord.attributes.spot.address') %></h3>
    <%= link_to @spot.full_address, "https://www.google.com/maps?q=#{CGI.escape(@spot.full_address)}", target: "_blank", rel: "noopener", class: "text-info text-lg underline" %>
    <div id="map" style="height: 400px;" class="mt-1 rounded"></div>
  <% else %>
    <p class="text-center"><%= t('.geolocation.error') %></p>
  <% end %>
</div>

<%# コメント部分 %>
<div class="flex w-3/5 flex-col mx-auto">
  <%= render 'comments/form', comment: @comment, spot: @spot %>

  <div class="divider"></div>

  <div id="comments">
    <% if @spot.comments.any? %>
      <%= render @spot.comments.order(created_at: :desc) %>
    <% else %>
      <p id="no_comments" class="text-center"><%= t('.no_comments') %></p>
    <% end %>
  </div>

  <div class="divider"></div>
</div>

<!-- 下部ボタン -->
<div class="w-3/5 mx-auto space-y-5">
  <% if current_user&.own?(@spot) %>
    <%= link_to t('.edit_spot'), edit_spot_path(@spot), class: "btn btn-primary w-full" %>
    <%= link_to t('.delete_spot'),
      @spot,
      data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
      class: "btn btn-error w-full" %>
  <% end %>

  <%= back_button %>
  <%= spots_index_button %>
</div>

<!-- JavaScript部 -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap">
</script>

<script>
  function initMap() {
    const spotLocation = { lat: <%= @spot.latitude %>, lng: <%= @spot.longitude %> };
    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 14,
      center: spotLocation,
    });

    new google.maps.Marker({
      position: spotLocation,
      map: map,
      title: "<%= @spot.name %>"
    });
  }
</script>
